import{jsx as e}from"react/jsx-runtime";import{useEffect as r,useSyncExternalStore as n,useState as t,useRef as o,useCallback as a,useMemo as i}from"react";var c=function(){return c=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var o in r=arguments[n])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},c.apply(this,arguments)};function u(e,r,n,t){return new(n||(n=Promise))((function(o,a){function i(e){try{u(t.next(e))}catch(e){a(e)}}function c(e){try{u(t.throw(e))}catch(e){a(e)}}function u(e){var r;e.done?o(e.value):(r=e.value,r instanceof n?r:new n((function(e){e(r)}))).then(i,c)}u((t=t.apply(e,r||[])).next())}))}function l(e,r){var n,t,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(n=1,t&&(o=2&c[0]?t.return:c[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,c[1])).done)return o;switch(t=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,t=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=r.call(e,i)}catch(e){c=[6,e],t=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}}var s="react-use-oauth2-state-key",d="react-use-oauth2-response",f=function(e){var r=new URLSearchParams(e);return Object.fromEntries(r.entries())},p=function(e,r,n,t,o,a,i){void 0===i&&(i={});var u,l=(u=c({response_type:a,client_id:r,redirect_uri:n,scope:t,state:o},i),new URLSearchParams(u).toString());return"".concat(e,"?").concat(l)},v=function(e,r){return e.postMessage(r)},w=function(e,r,n){clearInterval(e.current),r.current&&"function"==typeof r.current.close&&function(e){var r;null===(r=e.current)||void 0===r||r.close()}(r),sessionStorage.removeItem(s),window.removeEventListener("message",n)},h=function(n){var t=n.Component,o=void 0===t?e("div",c({style:{margin:"12px"},"data-testid":"popup-loading"},{children:"Loading..."})):t;return r((function(){var e=c(c({},f(window.location.search.split("?")[1])),f(window.location.hash.split("#")[1])),r=null==e?void 0:e.state,n=null==e?void 0:e.error,t=null===window||void 0===window?void 0:window.opener;if(!function(e){return null!=e}(t))throw new Error("No window opener");var o,a=r&&(o=r,sessionStorage.getItem(s)===o);if(!n&&a)v(t,{type:d,payload:e});else{var i=n?decodeURI(n):a?"OAuth error: An error has occured.":"OAuth error: State mismatch.";v(t,{type:d,error:i})}}),[]),o};const g=new Map;function m(e,c){if(void 0===n)throw new TypeError('You are using React 17 or below. Install with "npm install use-local-storage-state@17".');const[u]=t(null==c?void 0:c.defaultValue);if("undefined"==typeof window)return[u,()=>{},{isPersistent:!0,removeItem:()=>{}}];const l=null==c?void 0:c.serializer;return function(e,t,c=!0,u=S,l=JSON.stringify){g.has(e)||void 0===t||null!==T((()=>localStorage.getItem(e)))||T((()=>localStorage.setItem(e,l(t))));const s=o({item:null,parsed:t}),d=n(a((r=>{const n=n=>{e===n&&r()};return y.add(n),()=>{y.delete(n)}}),[e]),(()=>{var r;const n=null!==(r=T((()=>localStorage.getItem(e))))&&void 0!==r?r:null;if(g.has(e))s.current={item:n,parsed:g.get(e)};else if(n!==s.current.item){let e;try{e=null===n?t:u(n)}catch(r){e=t}s.current={item:n,parsed:e}}return s.current.parsed}),(()=>t)),f=a((r=>{const n=r instanceof Function?r(s.current.parsed):r;try{localStorage.setItem(e,l(n)),g.delete(e)}catch(r){g.set(e,n)}b(e)}),[e,l]);return r((()=>{if(!c)return;const r=r=>{r.storageArea===T((()=>localStorage))&&r.key===e&&b(e)};return window.addEventListener("storage",r),()=>window.removeEventListener("storage",r)}),[e,c]),i((()=>[d,f,{isPersistent:d===t||!g.has(e),removeItem(){T((()=>localStorage.removeItem(e))),g.delete(e),b(e)}}]),[e,f,d,t])}(e,u,null==c?void 0:c.storageSync,null==l?void 0:l.parse,null==l?void 0:l.stringify)}const y=new Set;function b(e){for(const r of[...y])r(e)}function S(e){return"undefined"===e?void 0:JSON.parse(e)}function T(e){try{return e()}catch(e){return}}var E=function(e){var r=e.authorizeUrl,n=e.clientId,i=e.redirectUri,f=e.scope,v=void 0===f?"":f,h=e.responseType,g=e.extraQueryParameters,y=void 0===g?{}:g,b=e.onSuccess,S=e.onError;!function(e){var r=e.authorizeUrl,n=e.clientId,t=e.redirectUri,o=e.responseType,a=e.extraQueryParameters,i=void 0===a?{}:a,c=e.onSuccess,u=e.onError;if(!(r&&n&&t&&o))throw new Error("Missing required props for useOAuth2. Required props are: {authorizeUrl, clientId, redirectUri, responseType}");if("code"===o&&!e.exchangeCodeForTokenServerURL)throw new Error('exchangeCodeForTokenServerURL is required for responseType of "code" for useOAuth2.');if("code"===o&&e.exchangeCodeForTokenMethod&&!["POST","GET"].includes(e.exchangeCodeForTokenMethod))throw new Error('Invalid exchangeCodeForTokenServerURL value. It can be one of "POST" or "GET".');if("object"!=typeof i)throw new TypeError("extraQueryParameters must be an object for useOAuth2.");if(c&&"function"!=typeof c)throw new TypeError("onSuccess callback must be a function for useOAuth2.");if(u&&"function"!=typeof u)throw new TypeError("onError callback must be a function for useOAuth2.")}(e);var T=o(y),E=o(),I=o(),x=t({loading:!1,error:null}),P=x[0],O=P.loading,k=P.error,U=x[1],A=m("".concat(h,"-").concat(r,"-").concat(n,"-").concat(v),{defaultValue:null}),L=A[0],C=A[1],R=A[2],F=R.removeItem,j=R.isPersistent,M="code"===h&&e.exchangeCodeForTokenServerURL,_="code"===h&&e.exchangeCodeForTokenMethod,z=a((function(){U({loading:!0,error:null});var e,t,o,a,f,g=(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=new Uint8Array(40),window.crypto.getRandomValues(t),t=t.map((function(r){return e.codePointAt(r%e.length)})),String.fromCharCode.apply(null,t));function m(e){var r,t,o;return u(this,void 0,void 0,(function(){var a,c,u;return l(this,(function(l){switch(l.label){case 0:if((null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.type)!==d)return[2];l.label=1;case 1:return l.trys.push([1,10,11,12]),"error"in e.data?(a=(null===(t=e.data)||void 0===t?void 0:t.error)||"Unknown Error occured.",U({loading:!1,error:a}),S?[4,S(a)]:[3,3]):[3,4];case 2:l.sent(),l.label=3;case 3:return[3,9];case 4:return c=null===(o=null==e?void 0:e.data)||void 0===o?void 0:o.payload,"code"===h&&M?[4,fetch(M,{headers:{"Content-Type":"application/x-www-form-urlencoded"},method:_||"POST",body:new URLSearchParams({client_id:n,grant_type:"authorization_code",code:null==c?void 0:c.code,redirect_uri:i})})]:[3,7];case 5:return[4,l.sent().json()];case 6:c=l.sent(),l.label=7;case 7:return U({loading:!1,error:null}),C(c),b?[4,b(c)]:[3,9];case 8:l.sent(),l.label=9;case 9:return[3,12];case 10:return u=l.sent(),console.error(u),U({loading:!1,error:u.toString()}),[3,12];case 11:return w(I,E,m),[7];case 12:return[2]}}))}))}return function(e){sessionStorage.setItem(s,e)}(g),E.current=(o=p(r,n,i,v,g,h,T.current),a=window.outerHeight/2+window.screenY-350,f=window.outerWidth/2+window.screenX-300,window.open(o,"OAuth2 Popup","height=".concat(700,",width=").concat(600,",top=").concat(a,",left=").concat(f))),window.addEventListener("message",m),I.current=setInterval((function(){var e,r,n;(!(null===(e=E.current)||void 0===e?void 0:e.window)||(null===(n=null===(r=E.current)||void 0===r?void 0:r.window)||void 0===n?void 0:n.closed))&&(U((function(e){return c(c({},e),{loading:!1})})),console.warn("Warning: Popup was closed before completing authentication."),w(I,E,m))}),250),function(){window.removeEventListener("message",m),I.current&&clearInterval(I.current)}}),[r,n,i,v,h,M,_,b,S,U,C]);return{data:L,loading:O,error:k,getAuth:z,logout:a((function(){F(),U({loading:!1,error:null})}),[F]),isPersistent:j}};export{h as OAuthPopup,E as useOAuth2};
