"use strict";var e=require("react/jsx-runtime"),r=require("react"),n=function(){return n=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var o in r=arguments[n])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},n.apply(this,arguments)};function t(e,r,n,t){return new(n||(n=Promise))((function(o,a){function i(e){try{u(t.next(e))}catch(e){a(e)}}function c(e){try{u(t.throw(e))}catch(e){a(e)}}function u(e){var r;e.done?o(e.value):(r=e.value,r instanceof n?r:new n((function(e){e(r)}))).then(i,c)}u((t=t.apply(e,r||[])).next())}))}function o(e,r){var n,t,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(u){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(n=1,t&&(o=2&c[0]?t.return:c[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,c[1])).done)return o;switch(t=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,t=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=r.call(e,i)}catch(e){c=[6,e],t=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,u])}}}var a="react-use-oauth2-state-key",i="react-use-oauth2-response",c=function(e){var r=new URLSearchParams(e);return Object.fromEntries(r.entries())},u=function(e,r,t,o,a,i,c){void 0===c&&(c={});var u,s=(u=n({response_type:i,client_id:r,redirect_uri:t,scope:o,state:a},c),new URLSearchParams(u).toString());return"".concat(e,"?").concat(s)},s=function(e,r){return e.postMessage(r)},l=function(e,r,n){clearInterval(e.current),r.current&&"function"==typeof r.current.close&&function(e){var r;null===(r=e.current)||void 0===r||r.close()}(r),sessionStorage.removeItem(a),window.removeEventListener("message",n)};const d=new Map;function f(e,n){if(void 0===r.useSyncExternalStore)throw new TypeError('You are using React 17 or below. Install with "npm install use-local-storage-state@17".');const[t]=r.useState(null==n?void 0:n.defaultValue);if("undefined"==typeof window)return[t,()=>{},{isPersistent:!0,removeItem:()=>{}}];const o=null==n?void 0:n.serializer;return function(e,n,t=!0,o=h,a=JSON.stringify){d.has(e)||void 0===n||null!==w((()=>localStorage.getItem(e)))||w((()=>localStorage.setItem(e,a(n))));const i=r.useRef({item:null,parsed:n}),c=r.useSyncExternalStore(r.useCallback((r=>{const n=n=>{e===n&&r()};return p.add(n),()=>{p.delete(n)}}),[e]),(()=>{var r;const t=null!==(r=w((()=>localStorage.getItem(e))))&&void 0!==r?r:null;if(d.has(e))i.current={item:t,parsed:d.get(e)};else if(t!==i.current.item){let e;try{e=null===t?n:o(t)}catch(r){e=n}i.current={item:t,parsed:e}}return i.current.parsed}),(()=>n)),u=r.useCallback((r=>{const n=r instanceof Function?r(i.current.parsed):r;try{localStorage.setItem(e,a(n)),d.delete(e)}catch(r){d.set(e,n)}v(e)}),[e,a]);return r.useEffect((()=>{if(!t)return;const r=r=>{r.storageArea===w((()=>localStorage))&&r.key===e&&v(e)};return window.addEventListener("storage",r),()=>window.removeEventListener("storage",r)}),[e,t]),r.useMemo((()=>[c,u,{isPersistent:c===n||!d.has(e),removeItem(){w((()=>localStorage.removeItem(e))),d.delete(e),v(e)}}]),[e,u,c,n])}(e,t,null==n?void 0:n.storageSync,null==o?void 0:o.parse,null==o?void 0:o.stringify)}const p=new Set;function v(e){for(const r of[...p])r(e)}function h(e){return"undefined"===e?void 0:JSON.parse(e)}function w(e){try{return e()}catch(e){return}}exports.OAuthPopup=function(t){var o=t.Component,u=void 0===o?e.jsx("div",n({style:{margin:"12px"},"data-testid":"popup-loading"},{children:"Loading..."})):o;return r.useEffect((function(){var e=n(n({},c(window.location.search.split("?")[1])),c(window.location.hash.split("#")[1])),r=null==e?void 0:e.state,t=null==e?void 0:e.error,o=null===window||void 0===window?void 0:window.opener;if(!function(e){return null!=e}(o))throw new Error("No window opener");var u,l=r&&(u=r,sessionStorage.getItem(a)===u);if(!t&&l)s(o,{type:i,payload:e});else{var d=t?decodeURI(t):l?"OAuth error: An error has occured.":"OAuth error: State mismatch.";s(o,{type:i,error:d})}}),[]),u},exports.useOAuth2=function(e){var c=e.authorizeUrl,s=e.clientId,d=e.redirectUri,p=e.scope,v=void 0===p?"":p,h=e.responseType,w=e.extraQueryParameters,g=void 0===w?{}:w,y=e.onSuccess,m=e.onError;!function(e){var r=e.authorizeUrl,n=e.clientId,t=e.redirectUri,o=e.responseType,a=e.extraQueryParameters,i=void 0===a?{}:a,c=e.onSuccess,u=e.onError;if(!(r&&n&&t&&o))throw new Error("Missing required props for useOAuth2. Required props are: {authorizeUrl, clientId, redirectUri, responseType}");if("code"===o&&!e.exchangeCodeForTokenServerURL)throw new Error('exchangeCodeForTokenServerURL is required for responseType of "code" for useOAuth2.');if("code"===o&&e.exchangeCodeForTokenMethod&&!["POST","GET"].includes(e.exchangeCodeForTokenMethod))throw new Error('Invalid exchangeCodeForTokenServerURL value. It can be one of "POST" or "GET".');if("object"!=typeof i)throw new TypeError("extraQueryParameters must be an object for useOAuth2.");if(c&&"function"!=typeof c)throw new TypeError("onSuccess callback must be a function for useOAuth2.");if(u&&"function"!=typeof u)throw new TypeError("onError callback must be a function for useOAuth2.")}(e);var S=r.useRef(g),b=r.useRef(),E=r.useRef(),x=r.useState({loading:!1,error:null}),T=x[0],I=T.loading,k=T.error,O=x[1],P=f("".concat(h,"-").concat(c,"-").concat(s,"-").concat(v),{defaultValue:null}),U=P[0],A=P[1],C=P[2],R=C.removeItem,L=C.isPersistent,j="code"===h&&e.exchangeCodeForTokenServerURL,F="code"===h&&e.exchangeCodeForTokenMethod,M=r.useCallback((function(){O({loading:!0,error:null});var e,r,f,p,w,g=(e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=new Uint8Array(40),window.crypto.getRandomValues(r),r=r.map((function(r){return e.codePointAt(r%e.length)})),String.fromCharCode.apply(null,r));function x(e){var r,n,a;return t(this,void 0,void 0,(function(){var t,c,u;return o(this,(function(o){switch(o.label){case 0:if((null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.type)!==i)return[2];o.label=1;case 1:return o.trys.push([1,10,11,12]),"error"in e.data?(t=(null===(n=e.data)||void 0===n?void 0:n.error)||"Unknown Error occured.",O({loading:!1,error:t}),m?[4,m(t)]:[3,3]):[3,4];case 2:o.sent(),o.label=3;case 3:return[3,9];case 4:return c=null===(a=null==e?void 0:e.data)||void 0===a?void 0:a.payload,"code"===h&&j?[4,fetch(j,{headers:{"Content-Type":"application/x-www-form-urlencoded"},method:F||"POST",body:new URLSearchParams({client_id:s,grant_type:"authorization_code",code:null==c?void 0:c.code,redirect_uri:d})})]:[3,7];case 5:return[4,o.sent().json()];case 6:c=o.sent(),o.label=7;case 7:return O({loading:!1,error:null}),A(c),y?[4,y(c)]:[3,9];case 8:o.sent(),o.label=9;case 9:return[3,12];case 10:return u=o.sent(),console.error(u),O({loading:!1,error:u.toString()}),[3,12];case 11:return l(E,b,x),[7];case 12:return[2]}}))}))}return function(e){sessionStorage.setItem(a,e)}(g),b.current=(f=u(c,s,d,v,g,h,S.current),p=window.outerHeight/2+window.screenY-350,w=window.outerWidth/2+window.screenX-300,window.open(f,"OAuth2 Popup","height=".concat(700,",width=").concat(600,",top=").concat(p,",left=").concat(w))),window.addEventListener("message",x),E.current=setInterval((function(){var e,r,t;(!(null===(e=b.current)||void 0===e?void 0:e.window)||(null===(t=null===(r=b.current)||void 0===r?void 0:r.window)||void 0===t?void 0:t.closed))&&(O((function(e){return n(n({},e),{loading:!1})})),console.warn("Warning: Popup was closed before completing authentication."),l(E,b,x))}),250),function(){window.removeEventListener("message",x),E.current&&clearInterval(E.current)}}),[c,s,d,v,h,j,F,y,m,O,A]);return{data:U,loading:I,error:k,getAuth:M,logout:r.useCallback((function(){R(),O({loading:!1,error:null})}),[R]),isPersistent:L}};
